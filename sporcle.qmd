---
title: Sporcle
format: 
  html:
    toc: true
    number-sections: true
params:
  solutions: true
---

::: {.callout-note}

<https://www.sporcle.com/games/subcategory/mlb>

You must **show your code**!!

:::

```{r}
#| message: false
library(tidyverse)
library(Lahman)
```

# Sporcle Quizzes

## 9/10: [MLB Teams Last MVP](https://www.sporcle.com/games/Knapster/mlbteammvp)

```{r}
#| include: !expr params$solutions
#| message: false
# find all active teams (teams that played in 2023)
active_teams <- Teams |>
  filter(yearID == 2023) |>
  select(teamID, name)

# find all MVPs
AwardsPlayers |>
  filter(awardID == "Most Valuable Player") |>
  # find out which team(s) they played for in that year
  left_join(
    Appearances, 
    by = join_by("playerID", "yearID", "lgID")
  ) |>
  # sort them by year
  arrange(desc(yearID)) |>
  group_by(teamID) |>
  # take the first one, since they're already sorted
  summarize(
    playerID = first(playerID),
    yearID = first(yearID)
  ) |>
  # now reduce to only the active teams!
  right_join(active_teams, by = join_by(teamID)) |>
  arrange(name) |>
  # get the players' names
  left_join(People, by = join_by(playerID)) |>
  mutate(Player = paste(nameFirst, nameLast)) |>
  # make the headers match
  select(Team = name, Player, Year = yearID) |>
  knitr::kable()
```

Here's what that would look like in SQL

```{sql}
#| connection: con
#| eval: false

SELECT 
  CONCAT(nameFirst, ' ', nameLast) AS Player, 
  t.name, 
  mvp_year AS Year
FROM AwardsPlayers ap
  LEFT JOIN Appearances a ON a.playerID = ap.playerID AND a.yearID = ap.yearID AND a.lgID = ap.lgID
  RIGHT JOIN (
    SELECT a.teamID, MAX(ap.yearID) AS mvp_year
    FROM AwardsPlayers ap
    LEFT JOIN Appearances a ON a.playerID = ap.playerID AND a.yearID = ap.yearID AND a.lgID = ap.lgID
    WHERE ap.awardID = 'Most Valuable Player' 
    GROUP BY a.teamID
    ORDER BY a.teamID
  ) last_mvps ON last_mvps.teamID = a.teamID AND last_mvps.mvp_year = a.yearID
  LEFT JOIN Teams t ON t.teamID = last_mvps.teamID
  LEFT JOIN People p ON p.playerID = a.playerID
WHERE ap.awardID = 'Most Valuable Player' 
  AND t.yearID = 2023
ORDER BY t.name;
```

```{r}
#| eval: false
#| include: false
dbGetQuery(con, "

SELECT 
  CONCAT(nameFirst, ' ', nameLast) AS Player, 
  t.name, 
  mvp_year AS Year
FROM AwardsPlayers ap
  LEFT JOIN Appearances a ON a.playerID = ap.playerID AND a.yearID = ap.yearID AND a.lgID = ap.lgID
  RIGHT JOIN (
    SELECT a.teamID, MAX(ap.yearID) AS mvp_year
    FROM AwardsPlayers ap
    LEFT JOIN Appearances a ON a.playerID = ap.playerID AND a.yearID = ap.yearID AND a.lgID = ap.lgID
    WHERE ap.awardID = 'Most Valuable Player' 
    GROUP BY a.teamID
    ORDER BY a.teamID
  ) last_mvps ON last_mvps.teamID = a.teamID AND last_mvps.mvp_year = a.yearID
  LEFT JOIN Teams t ON t.teamID = last_mvps.teamID
  LEFT JOIN People p ON p.playerID = a.playerID
WHERE ap.awardID = 'Most Valuable Player' 
  AND t.yearID = 2023
ORDER BY t.name;

")
```




## 9/15: 

# Appendix

## How to create a SQL duckdb database from the Lahman package { .appendix}

### Educate yourself

1. Read [*R for Data Science*, Ch. 21](https://r4ds.hadley.nz/databases.html)
1. See also [*Modern Data Science with R*, Ch. 15](https://mdsr-book.github.io/mdsr3e/15-sqlI.html)

### Instantiate the database

Create a duckdb instance 

```{r}
#| message: false
library(dbplyr)
library(duckdb)
con <- DBI::dbConnect(duckdb::duckdb())
```

### Populate the database

Start populating it with data from the **Lahman** package. 

```{r}
# Have to do this for every table...
dbWriteTable(con, "Teams", Lahman::Teams)
dbWriteTable(con, "People", Lahman::People)
dbWriteTable(con, "Appearances", Lahman::Appearances)
dbWriteTable(con, "AwardsPlayers", Lahman::AwardsPlayers)
dbWriteTable(con, "TeamsFranchises", Lahman::TeamsFranchises)
```

::: {.callout-tip}

Challenge: Use a `map()` statement to do them all!

:::

### Step 4: Inpsect the database

```{r}
dbListTables(con)
```

### Access

Now, you can access the data in your duckdb SQL database in several ways.

#### Using `dbplyr`

```{r}
teams <- tbl(con, "Teams")

active_teams <- teams |>
  filter(yearID == 2023) |>
  select(teamID, name)

active_teams
```

And you can see the translated SQL query!

```{r}
active_teams |>
  show_query()
```

#### Using `DBI`

If you want to practice writing the raw SQL query

```{r}
con |>
  dbGetQuery(
"
SELECT teamID, name
FROM teams
WHERE yearID = 2023;
"
)
```

#### Using Quarto/Markdown

If you want SQL syntax highlighting, and to use the data back in R, make an SQL chunk

```{sql}
#| connection: con
#| output.var: "teams_sql"
#| echo: fenced
SELECT teamID, name
FROM teams
WHERE yearID = 2023;
```

```{r}
#| echo: fenced
teams_sql
```



